# Build, generate keystore, sign, upload AAB to Play Console (internal track).
# Run manually (workflow_dispatch) or on push to main.
name: Build & Publish (generate keystore)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

env:
  PACKAGE_NAME: com.maximehoullier.myapp

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Generate keystore and credentials
        id: gen_keystore
        run: |
          set -euo pipefail

          # configurable alias
          KEY_ALIAS="myapp_key"

          # generate reasonably-random passwords (alphanumeric)
          KEYSTORE_PASSWORD=$(openssl rand -base64 18 | tr -dc 'A-Za-z0-9' | cut -c1-24)
          KEY_PASSWORD=$(openssl rand -base64 18 | tr -dc 'A-Za-z0-9' | cut -c1-24)

          echo "KEY_ALIAS=${KEY_ALIAS}" >> $GITHUB_OUTPUT
          echo "KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}" >> $GITHUB_OUTPUT
          echo "KEY_PASSWORD=${KEY_PASSWORD}" >> $GITHUB_OUTPUT

          # generate keystore file (validity 10000 days)
          keytool -genkeypair -v \
            -keystore release.keystore \
            -storepass "${KEYSTORE_PASSWORD}" \
            -keypass "${KEY_PASSWORD}" \
            -alias "${KEY_ALIAS}" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=MyApp, OU=Dev, O=MyApp, L=City, ST=Region, C=FR"

          # Save an info file (for artifact)
          cat > keystore-info.txt <<EOF
keystore: release.keystore
alias: ${KEY_ALIAS}
keystore_password: ${KEYSTORE_PASSWORD}
key_password: ${KEY_PASSWORD}

IMPORTANT:
- Download and store release.keystore and keystore-info.txt immediately.
- Keep them safe: you will need this keystore to update your app on Google Play.
EOF

      - name: Write gradle.properties for signing
        run: |
          # Write properties expected by app/build.gradle signingConfig
          cat > gradle.properties <<EOF
KEYSTORE_PASSWORD=${{ steps.gen_keystore.outputs.KEYSTORE_PASSWORD }}
KEY_ALIAS=${{ steps.gen_keystore.outputs.KEY_ALIAS }}
KEY_PASSWORD=${{ steps.gen_keystore.outputs.KEY_PASSWORD }}
EOF

      - name: Build release AAB
        run: ./gradlew bundleRelease --no-daemon

      - name: Upload AAB artifact (for manual download)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/app-release.aab

      - name: Upload keystore artifact (download and keep!)
        uses: actions/upload-artifact@v4
        with:
          name: generated-keystore
          path: |
            release.keystore
            keystore-info.txt

      - name: Publish to Google Play (internal)
        if: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON != '' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.PACKAGE_NAME }}
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal
