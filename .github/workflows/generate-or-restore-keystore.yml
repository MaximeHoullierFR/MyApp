# Generate or restore keystore, build signed AAB, upload artifacts
name: Build & Publish (keystore restore/generate)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

env:
  PACKAGE_NAME: com.maximehoullier.myapp

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # If we have KEYSTORE_BASE64 secret, restore it
      - name: Restore keystore from secret (if provided)
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: |
          echo "Restoring keystore from KEYSTORE_BASE64"
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.keystore
          # optionally set alias/password from secrets if you stored them separately
          # e.g. use secrets.KEY_ALIAS, secrets.KEYSTORE_PASSWORD, secrets.KEY_PASSWORD

      # Otherwise generate a new keystore and expose credentials as outputs
      - name: Generate keystore (only when no KEYSTORE_BASE64)
        if: ${{ secrets.KEYSTORE_BASE64 == '' }}
        id: gen
        run: |
          set -euo pipefail
          KEY_ALIAS="myapp_key"
          KEYSTORE_PASSWORD=$(openssl rand -base64 18 | tr -dc 'A-Za-z0-9' | cut -c1-24)
          KEY_PASSWORD=$(openssl rand -base64 18 | tr -dc 'A-Za-z0-9' | cut -c1-24)

          echo "KEY_ALIAS=${KEY_ALIAS}" >> $GITHUB_OUTPUT
          echo "KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}" >> $GITHUB_OUTPUT
          echo "KEY_PASSWORD=${KEY_PASSWORD}" >> $GITHUB_OUTPUT

          keytool -genkeypair -v \
            -keystore release.keystore \
            -storepass "${KEYSTORE_PASSWORD}" \
            -keypass "${KEY_PASSWORD}" \
            -alias "${KEY_ALIAS}" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=MyApp, OU=Dev, O=MyApp, L=City, ST=Region, C=FR"

          cat > keystore-info.txt <<EOF
keystore: release.keystore
alias: ${KEY_ALIAS}
keystore_password: ${KEYSTORE_PASSWORD}
key_password: ${KEY_PASSWORD}

IMPORTANT:
- Download and store release.keystore and keystore-info.txt immediately.
EOF

      - name: Write gradle.properties for signing
        run: |
          # Prefer explicit secrets when available, otherwise use generated outputs
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD || steps.gen.outputs.KEYSTORE_PASSWORD }}" > gradle.properties
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS || steps.gen.outputs.KEY_ALIAS }}" >> gradle.properties
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD || steps.gen.outputs.KEY_PASSWORD }}" >> gradle.properties

      - name: Build release AAB
        run: ./gradlew bundleRelease --no-daemon

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/app-release.aab

      - name: Upload generated keystore (artifact) â€” only if we generated it now
        if: ${{ secrets.KEYSTORE_BASE64 == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: generated-keystore
          path: |
            release.keystore
            keystore-info.txt

      # optional: publish to Play if service account JSON is present
      - name: Publish to Google Play (internal) (optional)
        if: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON != '' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.PACKAGE_NAME }}
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal
